version: 2.1

workflows:
  version: 2
  main:
    jobs:
      - my-test-build:
          context: v111-kublr-demo

jobs:
  my-test-build:
    docker:
      - image: circleci/node:4.8.2
    steps:
      - checkout
      - run: echo "hello world"
      - kublr-auth


commands:
  kublr-auth:
    description: "Authenticate in Kublr Control Plane"
    parameters:
      kublr-endpoint:
        type: env_var_name
        description: Kublr Control Plane URL
        default: KUBLR_ENDPOINT
      kublr-username:
        type: env_var_name
        description: Kublr Control Plane Username
        default: KUBLR_USERNAME
      kublr-password:
        type: env_var_name
        description: Kublr Control Plane Password
        default: KUBLR_PASSWORD
    steps:
      - run: |
          KUBLR_TOKEN="$(curl \
            -d "grant_type=password" \
            -d "client_id=kublr-ui" \
            -d "username=${<<parameters.kublr-username>>}" \
            -d "password=${<<parameters.kublr-password>>}" \
            "${<<parameters.kublr-endpoint>>}/auth/realms/kublr-ui/protocol/openid-connect/token" | jq -r '.access_token')"
      - run: 'echo Token ${KUBLR_TOKEN}'
