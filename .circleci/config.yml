version: 2.1

workflows:
  version: 2
  main:
    jobs:
      - my-test-build:
          context: v111-kublr-demo

jobs:
  my-test-build:
    docker:
      - image: circleci/node:4.8.2
    steps:
      - checkout
      - run: echo "Hello world"
      - kublr-auth
      - run: 'echo Token ${KUBLR_TOKEN}'

commands:
  kublr-auth:
    description: "Authenticate in Kublr Control Plane"
    parameters:
      kublr-endpoint:
        type: env_var_name
        description: Kublr Control Plane URL
        default: KUBLR_ENDPOINT
      kublr-username:
        type: env_var_name
        description: Kublr Control Plane Username
        default: KUBLR_USERNAME
      kublr-password:
        type: env_var_name
        description: Kublr Control Plane Password
        default: KUBLR_PASSWORD
      kublr-token:
        type: env_var_name
        description: Kublr Control Plane Password
        default: KUBLR_TOKEN
    steps:
      - run: |
          if [ -n "${<<parameters.kublr-token>>:-}" ] ; then
            if ! curl -s -f -H "Authorization: Bearer ${<<parameters.kublr-token>>:-}" "${<<parameters.kublr-endpoint>>}/api/meta/version" > /dev/null ; then
              echo "Kublr token is expired, refresh"
              export <<parameters.kublr-token>>=
            else
              echo "Kublr token is valid"
            fi
          fi
          if [ -z "${<<parameters.kublr-token>>:-}" ] ; then
            echo "Refreshing Kublr token"
            KUBLR_RESPONSE="$(curl -s \
              -d "grant_type=password" \
              -d "client_id=kublr-ui" \
              -d "username=${<<parameters.kublr-username>>}" \
              -d "password=${<<parameters.kublr-password>>}" \
              "${<<parameters.kublr-endpoint>>}/auth/realms/kublr-ui/protocol/openid-connect/token")"
            export <<parameters.kublr-token>>="$(echo "${KUBLR_RESPONSE:-}" | jq -r '.access_token // empty')"
            if [ -n "${<<parameters.kublr-token>>:-}" ]; then
              echo "Kublr token refresh successful"
              echo "export <<parameters.kublr-token>>='${<<parameters.kublr-token>>}'" >> $BASH_ENV
            else
              echo "Kublr token refresh failed, response: ${KUBLR_RESPONSE}"
              exit 1
            fi
          fi
